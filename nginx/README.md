# nginx/: NGINX и API-сервер

В папке `nginx/` находится конфигурация центрального узла, объединяющего веб-сервер NGINX и Python API для управления маршрутизацией. Этот компонент выполняет следующие функции:

* **Хранение и выдача конфигурационных файлов:** Файлы маппинга `ip_mapping.json` и `port_mapping.json` располагаются так, чтобы их можно было получить по HTTP-запросу. NGINX настроен раздавать эти JSON-файлы статически (например, по запросу `/ip_mapping.json` возвращается текущая привязка IP к проектам). Это позволяет контейнерам и вспомогательным скриптам получать актуальную информацию о распределении ресурсов.

* **API для доступных портов:** Python-сервер предоставляет эндпоинт `/available_ports`, возвращающий список свободных портов по каждому проекту. Этот список вычисляется на основе `port_mapping.json` (разрешённые порты) с учётом уже занятых портов. Таким образом, контейнер, запрашивая `/available_ports`, получает структуру вида `{ "project1": { "available_ports": [ ... ] }, "project2": { ... }, "other": { ... } }` и может определить, где есть свободные слоты для подключения.

* **Приём команд от удалённых контейнеров:** Reverse Proxy Container не напрямую пишет в файлы маппинга, вместо этого он взаимодействует с сервером по SSH. При необходимости добавить новый IP-адрес, контейнер устанавливает SSH-соединение и удалённо выполняет скрипт `run_add_project_address.py` на стороне сервера. Этот скрипт обновляет `ip_mapping.json`, добавляя IP в список проекта, и выполняет валидацию. Он проверяет, принадлежит ли запрошенный порт данному проекту (сопоставляется с `port_mapping.json`), и не числится ли IP уже за другим проектом. Если проверка не проходит, IP не будет добавлен, и скрипт вернёт ошибку – это защита от неправильного распределения ресурсов.

* **Исключение дублирования IP:** Логика Python-API гарантирует целостность данных. Один и тот же IP-адрес не может быть записан в `ip_mapping.json` более чем в одном разделе проекта. Если поступает попытка назначить IP, который уже закреплён за другим проектом, API вернёт сообщение об ошибке, а привязка отклонится. Благодаря этому, даже если два контейнера случайно обнаружат одинаковый IP (теоретически в редких случаях), сервер не позволит конфликтующей ситуации.

* **Дополнительные утилиты:** В папке `nginx/` есть и другие вспомогательные скрипты (например, для удаления или перезапуска приложений: `run_remove_app.py`, `run_restart_app.py`, скрипты в подпапке fluxsign/ для интеграции с Flux API). Эти скрипты вызываются при особых условиях – например, когда IP попадает в «чёрный список» или когда нужно инициировать перезапуск контейнера на основе внешних сигналов. Также на стороне NGINX может работать SSH-сервер (в контексте контейнера или хоста), который принимает туннельные подключения от удалённых Reverse Proxy контейнеров.

**API-сервер NGINX** является центральным узлом координации: он раздаёт актуальные данные о свободных портах, принимает команды на добавление/удаление IP, и обеспечивает, чтобы правила распределения (порт к проекту, IP к проекту) не нарушались. В итоге, все удалённые контейнеры доверяют этому серверу как источнику правды для сетевых настроек.

## Переменные окружения

Скрипты в этом каталоге используют следующие переменные окружения (значения по умолчанию указаны в скобках):

- `BLACKLIST_FILE` – путь к файлу чёрного списка (`/usr/share/nginx/html/blacklist.json`)
- `WHITELIST_FILE` – путь к файлу белого списка (`/usr/share/nginx/html/whitelist.json`)
- `API_USAGE_LOG` – файл журнала использования API (`/tmp/iphub_api_usage.log`)
- `PORTS_FILE` – конфигурация доступных портов (`/usr/share/nginx/html/port_mapping.json`)
- `IP_MAPPING_FILE` – маппинг проектов на IP (`/usr/share/nginx/html/ip_mapping.json`)